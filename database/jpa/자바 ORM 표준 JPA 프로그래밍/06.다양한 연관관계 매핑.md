## 06. 다양한 연관관계 매핑

----

- 다대일 [N:1]
  - 가장 많이 사용하는 연관관계
- 일대다 [1:N]
  - JPA에서 지원하지만 실무에서 거의 사용하지 않음.
  - 일대다 단방향 매핑의 단점
    1. 엔티티가 관리하는 외래 키가 다른 테이블에 있음
    2. 연관관계 관리를 위해 추가로 UPDATE SQL 실행
  - 일대다 양방향 정리
    1. 이런 매핑은 공식적으로 존재 X
    2. 읽기 전용 필드를 사용해서 양방향처럼 사용하는 방법
  - **일대다 단반향 매핑보다는 다대일 양방향 매핑을 사용하자!**
- 일대일 [1:1]
  - 주 테이블이나 대상 테이블 중에 외래 키 선택 가능
  - 외래 키에 데이터베이스 유니크(UNI) 제약조건 추가
  - 일대일 정리
    1. 주 테이블(access가 많은 테이블)에 외래 키
       - 주 객체가 대상 객체의 참조를 가지는 것처럼 주 테이블에 외래 키를 두고 대상 테이블을 찾음
       - 객체지향 개발자 선호
       - JPA 매핑 편리
       - 장점: 주 테이블만 조회해도 대상 테이블에 데이터가 있는지 확인 가능
       - 단점: 값이 없으면 외래 키에 null 허용
    2. 대상 테이블에 외래 키
       - 대상 테이블에 외래 키가 존재
       - 전통적인 데이터베이스 개발자 선호
       - 장점: 주 테이블과 대상 테이블을 일대일에서 일대다 관계로 변경할 때 테이블 구조 유지
       - 단점: **프록시 기능의 한계로 지연 로딩으로 설정해도 항상 즉시 로딩됨** (추후 Fetch Join 등으로 해결)
         - 주 테이블에 외래 키가 있는 경우 외래 키가 null인지 아닌지만 확인하여 프록시 객체를 생성할 수 있지만
           대상 테이블에 외래 키가 있는 경우는 select query를 날려봐야 알 수 있으므로 지연 로딩으로 설정해도 즉시 로딩이 된다.
  - 다대다 [N:M]
    - 관계형 데이터베이스는 정규화된 테이블 2개로 다대다 관계를 표현할 수 없음
    - 편리해 보이지만 **실무에서 사용 X**
      - 연결 테이블을 추가해서 일대다, 다대일 관계로 풀어내야함
      - 연결 테이블이 단순히 연결만 하고 끝나지 않음
      - 주문시간, 수량 같은 데이터가 들어올 수 있음
    - 다대다 한계 극복
      - 연결 테이블용 엔티티 추가 (연결 테이블을 엔티티로 승격)
      - @ManyToMany -> @OneToMany, @ManyToOne

----

- @JoinColumn
  - name: 매핑할 외래 키 이름
  - referencedColumnName: 외래 키가 참조하는 대상 테이블의 컬럼명
  - foreignKey(DDL): 외래 키 제약조건을 직접 지정할 수 있다. (이 속성은 테이블을 생성할 때만 사용한다.)
  - unique, nullable, insertable, updatable, columnDefinition, table
- @ManyToOne
  - optional: false로 설정하면 연관된 엔티티가 항상 있어야 한다.
  - fetch: 글로벌 페치 전략을 설정한다.
  - cascade: 영속성 전이 기능을 사용한다.
- @OneToMany
  - mappedBy: 연관관계의 주인 필드를 선택한다.
  - fetch: 글로벌 페치 전략을 설정한다.
  - cascade: 영속성 전이 기능을 사용한다.