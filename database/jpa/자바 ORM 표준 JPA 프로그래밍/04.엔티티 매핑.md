## 04. 엔티티 매핑

----

##### 엔티티 매핑 소개

- 객체와 테이블 매핑: **@Entity, @Table**
  - @Entity
    - @Entitiy가 붙은 클래스는 JPA가 관리, 엔티티라 한다.
    - JPA를 사용해서 테이블과 매핑할 클래스는 @Entity 필수
    - 속성: name
      - JPA에서 사용할 엔티티 이름을 지정한다.
      - 기본값: 클래스 이름을 그대로 사용
      - 같은 클래스 이름이 없으면 가급적 기본값을 사용한다.
    - 주의
      - 기본 생성자 필수 (파라미터가 없는 public 또는 protected 생성자)
      - final 클래스, enum, interface, inner 클래스 사용 X
      - 저장할 필드에 final 사용 X
  - @Table
    - 속성
      - name - 매핑할 테이블 이름
      - catalog - 데이터베이스 catalog 매핑
      - schema - 데이터베이스 schema 매핑
      - uniqueConstraints - DDL 생성 시에 유니크 제약 조건 생성
- 필드와 컬럼 매핑: **@Column**
  - DDL 생성 기능
    - 제약 조건 추가 - @Column(nullable = false, unique = true, length = 10)
    - DDL 생성 기능은 DDL을 자동 생성할 때만 사용되고 JPA의 실행 로직에는 영향을 주지 않는다.
- 연관관계 매핑: **@ManyToOne, @JoinColumn**



##### 매핑 어노테이션 정리

- @Id
  - 직접 할당: @Id만 사용
  - 자동 생성(@GeneratedValue)
    - **IDENTITY**: 데이터베이스에 위임, MYSQL
      - AUTO_ INCREMENT는 데이터베이스에 INSERT SQL을 실행한 이후에 ID 값을 알 수 있기 때문에 em.persist() 시점에 즉시 INSERT SQL 실행 하고 DB에서 식별자를 조회
    - **SEQUENCE**: 데이터베이스 시퀀스 오브젝트 사용, ORACLE
    - **TABLE**: 키 생성용 테이블 사용, 모든 DB에서 사용
    - **AUTO**: 방언에 따라 자동 지정, 기본값

- @Column - 컬럼 매핑
  - name - 필드와 매핑할 테이블의 컬럼 이름
  - insertable, updatable - 등록, 변경 가능 여부
  - nullable(DDL) - null 값의 허용 여부를 설정한다.
  - unique(DDL) - @Table의 uniqueConstraints와 같지만 한 컬럼에 간단히 유니크 제약조건을 걸 때 사용한다.
  - columnDefinition(DDL) - 데이터베이스 컬럼 정보를 직접 줄 수 있다.
  - length(DDL) - 문자 길이 제약조건, String 타입에만 사용한다. (기본 - 255)
  - precision, scale(DDL) - 소수점 관련
- @Temporal - 날짜 타입 매핑
  - 날짜타입(Date, Calendar)을 매핑할 때 사용
    - TemporalType.DATE, TemporalType.TIME, TemporalType.TIMESTAMP
  - LocalDate, LocalDateTime을 사용할 때는 생략 가능 (최신 하이버네이트 지원)
- @Enumerated - enum 타입 매핑
  - 자바 enum 타입을 매핑할 때 사용 
  - 주의! ORDINAL(default) 사용 X
    - 요구사항이 변경되어 enum의 순서가 변경 시, 문제 발생
    - EnumType.ORDINAL: enum 순서를 데이터베이스에 저장
    - EnumType.STRING: enum 이름을 데이터베이스에 저장
- @Lob - BLOB, CLOB 매핑
  - 매핑하는 필드 타입이 문자면 CLOB 매핑, 나머지는 BLOB 매핑
- @Transient - 특정 필드를 컬럼에 매핑하지 않음



##### 데이터베이스 스키마 자동 생성

- DDL을 애플리케이션 실행 시점에 자동 생성
- 테이블 중심 -> 객체 중심
- 데이터베이스 방언을 활용해서 데이터베이스에 맞는 적절한 DDL 생성
- 이렇게 생성된 DDL은 개발 장비에서만 사용
- 생성된 DDL은 운영서버에서는 사용하지 않거나, 적절히 다듬은 후 사용
- 스키마 자동 생성  - 속성: hibernate.hbm2ddl.auto
  - create - 기존 테이블 삭제 후 다시 생성
  - create-drop create와 같으나 종료시점에 테이블 drop
  - update - 변경분만 반영
  - validate - 엔티티와 테이블이 정상 매핑되었는지만 확인
  - none - 사용하지 않음
- 주의
  - 운영 장비에는 절대 create, create-drop, update 사용하면 안된다.
  - 개발 초기에는 create or update
  - 테스트 서버는 update or validate
  - 스테이징과 운영 서버는 validate or none