## TCP/IP 4계층

---

##### TCP/IP 4계층 #1. 개념, 캡슐화, 비캡슐화, PDU, OSI 7계층

1. 개념
   - TCP/IP 4계층은 장치들이 인터넷 상에서 데이터를 주고받을 때 쓰는 독립적인 프로토콜의 집합을 의미합니다.
     TCP/IP는 TCP(Transmission Control Protocol) / IP(Internet Protocol)이라는 의미인데 인터넷을 통해 데이터를 보낼 때 주로 TCP와 IP를 이용해서 보내기 때문에 이런 용어를 가집니다.
   - 계층
     1. Application (응용 계층)
        - HTTP(S), SMTP, SSH, FTP가 대표적이며 웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층입니다
     2. Transport (전송 계층)
        - UDP, TCP가 대표적이며 애플리케이션 계층에서 받은 메시지를 기반으로 세그먼트 또는 데이터그램으로 데이터를 쪼개고 데이터가 오류없이 순서대로 전달되도록 도움을 주는 계층입니다.
     3. Internet (인터넷 계층)
        - IPv4/IPv6, ICMP, ARP가 대표적이며 한 노드에서 다른 노드로 전송 계층에서 받은 세그먼트 또는 데이터그램을 패킷화 하여 목적지로 전송하는 역할을 담당합니다.
     4. Network Access (링크(=네트워크) 계층)
        - 링크 계층은 전선, 광섬유, 무선 등으로 데이터가 네트워크를 통해 물리적으로 전송되는 방식을 정의합니다.
   - 캡슐화와 비캡슐화
     - 네트워크에서 캡슐화(encapsulation)란 송신자가 수신자에게 데이터를 보낼 때 데이터가 각 계층을 지나며 각 계층의 특징들이 담긴 헤더들이 붙여지는 과정을 의미합니다.
       예를 들어 전송계층은 TCP 헤더, 네트워크 계층은 IP 주소 헤더를 추가하는 것이죠. 비캡슐화(decapsulation)란 이 과정의 역과정입니다. 수신자측에서는 이렇게 캡슐화된 데이터를 역순으로 제거하면서 응용계층까지 도달하는 것을 말합니다.
   - **PDU**(protocol data unit)
     - TCP/IP 4계층을 기반으로 설명했을 때 각 계층의 데이터 단위를 의미
       - 애플리케이션 계층: 메시지
       - 전송 계층: **세그먼트(TCP), 데이터그램(UDP)**
       - 인터넷 계층: 패킷
       - 링크 계층: 프레임(데이터 링크 계층), 비트(물리 계층)
         - **세그먼트** : 적절한 크기로 쪼갠 조각 (세그먼트와 데이터그램의 의미는 같습니다.)
         - **패킷** : 세그먼트에 SP와 DP가 포함된 IP 헤더가 붙은 형태의 조각
           - SP: 송신자의 32비트 IP주소
           - DP: 수신자의 32비트 IP주소
             - IPv4 기준
         - **프레임** : MAC주소 헤더와 CRC/체크섬 트레일러가 붙은 조각
           - CRC/체크섬 트레일러: 데이터의 오류감지를 위한 수학적 함수가 적용된 값. 링크의 오류(과도한 트래픽 등)로 인해 데이터의 손상을 감지하는 역할을 합니다.
             참고로 모든 계층에 전달되는 데이터가 쪼개져서 '패킷'으로 전달된다고도 하는 것도 대강 맞는 말이나 PDU에 따라 부르는게 더 맞는 표현입니다.
   - OSI 7계층
     - TCP / IP 4계층은 OSI 7계층 모델로 설명하기도 합니다.
       TCP/IP 계층과 달리 OSI 계층은 애플리케이션 계층을 세 개로 쪼개고 
       링크 계층을 데이터 링크 계층, 
       물리 계층으로 나눠서 표현하는 것이 다르며 
       인터넷 계층을 네트워크 계층으로 부른다는 점이 다릅니다.

-----

##### TCP/IP 4계층 \#2. MTU와 MSS와 PMTUD

- **MTU**(Maximum Transmission Unit)란 네트워크에 연결된 장치가 받아들일 수 있는 최대 데이터 패킷의 크기를 말합니다.
  - 이크기를 기준으로 데이터는 쪼개져서 패킷화됩니다. 
  - 네트워크 경로 상에 있는 아무 장치나 MTU보다 패킷이 크면 그 패킷은 분할될 수도 있습니다.
- 패킷이 분할되지 않는 경우
  - 패킷을 분할할 수 없어 네트워크 경로 상에 있는 어떠한 라우터나장치의MTU를초과할때 분할해서 전달하는 것이 아니라 전달을 아예 하지 않을 수도 있습니다.
  - IPv6: 분할을 허용하지 않는다.
  - IPv4: 헤더에 flags라는 필드가 있는데 여기서 bit가 1이 되면 분할이 불가능하다.
- MTU와 **MSS**의 차이를 보면 다음과 같이 MTU는 IP헤더와 TCP헤더의 크기까지 합치지만 MSS(Maximum Segment Size)는 데이터의 크기(payload의 크기)만을 가리킵니다.
  일반적으로 MTU는 1500바이트이며 MSS는 1460바이트입니다. 따라서 네트워크를 통해 데이터를 보낼 때 MTU가 1500이라도 데이터는 보통 1460바이트 이하의 크기로 보내야 전달이 됩니다.
- **PMTU(Path MTU Discovery**는 수신자와 송신자의 경로 상에서 장치가 패킷을 누락한 경우 테스트 패킷의 크기를 낮추면서 MTU에 맞게끔 반복해서 보내는 과정을 말합니다.

----

**TCP/IP 4계층 \#3. 애플리케이션 계층(application) HTTP, SSH, FTP, SMTP**

- HTTP, SMTP, SSH, FTP가 대표적이며 웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층입니다.

- HTTP (Hypertext Transfer Protocol)

  - HTTP은 처음에는 서버와 브라우저간에 데이터를 주고 받기 위해 설계된 프로토콜입니다. 
    지금은 브라우저 뿐만 아니라 서버와 서버간의 통신할 때도 많이 이용합니다.
    1. HTTP는 헤더를 통한 확장이 쉽습니다.
       - 예를 들어 헤더 값에다가 어떠한 값을 넣어서 HTTP요청을 할 때 쉽게 다른 값을 추가할 수 있습니다.
    2. HTTP는 stateless합니다.
       - 동일한 연결에서 연속적으로 수행되는 두 요청 사이에 연속적인 상태(state)값은 없습니다.

- SSH (Secure SHhell Protocol)

  - SSH는 보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호화 네트워크 프로토콜 입니다.

  - ```sh
    # AWS 내의 EC2에 접근하는 모습.
    # 보통 프라이빗 키가 있는 경로에서 이런식으로 키를 명시하고 실행합니다.
    ssh <pem> <user>@<serverIP>
    
    # SCP를 이용해서 SSH를 이용해 파일을 전송할 수 있습니다.
    scp <source> <destination>
    ```

- FTP (File Transfer Protocol)

  - FTP는 노드와 노드간의 파일을 전송하는데 사용되는 프로토콜입니다.
  - 지금은 파일을 암호화해서 전송하는 FTPS 또는 SFTP로 대체되고 있습니다.

- SMTP (Simple Mail Transfer Protocol)

  - 인터넷을 통해 메일을 보낼 때 사용되는 프로토콜입니다.

----

##### **TCP/IP 4계층 \#4. 전송 계층(transport) TCP와 UDP**

- TCP, UDP가 대표적이며 애플리케이션 계층에서 받은 메시지를 기반으로 세그먼트(TCP) 또는 데이터그램(UDP)으로 데이터를 쪼개고 데이터를 오류없이 순서대로 전달되도록 도움을 주는 층입니다.
- TCP
  1. 가상회선 패킷 교환방식 (패킷 순서 보장 O)
  2. 신뢰성: O
  3. 오류검사 (재전송, 체크섬)
     1. 재전송: 시간 초과 기간이 지나면 서버는 전달되지 않은 데이터에 대해 재전송을 시도합니다.
     2. 체크섬: 체크섬을 통해 무결성을 평가합니다. 즉, 송신된 데이터의 체크섬과 수신된 데이터의 체크섬 값을 비교해서 올바르게 왔는지를 확인
  4. 헤더 길이
     - TCP 헤더는 20~60 바이트로 가변적
  5. 연결보장: 연결을 보장함.
     - 3way-handshake로 연결을 맺고 4way-handshake로 연결을 해제하는 작업이 필요.
  6. 브로드 캐스트 지원 X
  7. 속도: 느림
- UDP
  1. 데이터그램 패킷 교환방식 (패킷 순서 보장  X)
  2. 신뢰성: X
  3. 오류검사 (체크섬)
  4. 헤더 길이
     - 32비트(8바이트)로 고정길이
  5. 연결 보장: 연결을 보장하지 않음.
     - 그냥 데이터를 보냄. 연결을 유지하고 해제하는데 드는 비용이 없음.
  6. 브로드 캐스트 지원 O
  7. 속도: 빠름

----

**TCP/IP 4계층 \#5. 인터넷 계층(network) ICMP**

- **인터넷계층**
  - IP, ICMP, ARP가 대표적이며 한 노드에서 다른 노드로 전송 계층에서 받은 세그먼트 혹은 데이터그램을 패킷화 하여 전송합니다.
- **ICMP (Internet Control Message Protocol)**
  - ICMP는 노드와 노드 사이에서 통신이 잘 되나를 확인할 때 쓰는 프로토콜입니다.
    이는 데이터를 교환하는데 사용되지 않는 프로토콜입니다.
  - 일반적으로 테스팅에 사용됩니다.
  - IP와는 달리 TCP 또는 UDP 와 같은 전송 계층 프로토콜과 연관되지 않고 독립적인 비연결형 프로토콜로 . 이것은 ICMP를 비연결형 프로토콜을 기반으로 구축됩니다.
    - ex: ping
