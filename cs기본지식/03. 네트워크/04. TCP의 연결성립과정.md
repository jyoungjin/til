## TCP의 연결성립과정

---

##### TCP의 연결성립과정: 3-웨이 핸드쉐이크

1. SYN 단계: 클라이언트는 서버에 클라이언트의 ISN을 담아 SYN을 보냄.
2. SYN + ACK 단계: 서버는 클라이언트의 SYN을 수신하고 서버의 ISN을 보내며 승인번호로 클라이언트의 ISN + 1을 보냄.
3. ACK 단계: 클라이언트는 서버의 ISN + 1한 값인 승인번호를 담아 ACK를 서버에 보냄.

- ISN: TCP(Transmission Control Protocol) 기반 데이터 통신에서 각각의 새 연결에 할당된 고유한 32비트 시퀀스 번호를 나타냅니다.
  TCP 연결을 통해 전송되는 다른 데이터 바이트와 충돌하지 않는 시퀀스 번호를 할당하는 데 도움이 됩니다.

- SYN: synchronization의 약자, 연결 요청 플래그

- ACK: acknowledgement의 약자, 응답 플래그

- 클라이언트와 서버의 상태

  - 서버는 LISTEN 상태에서만 클라이언트의 요청을 받을 수 있다.
    1. [ 클라이언트 ] CLOSED
    2. [ 서버 ] CLOSED -> LISTEN
    3. [ 클라이언트 ] SYN-SENT
    4. [ 서버 ] SYN-RECEIVED
    5. [ 클라이언트 ] ESTABLISHED
    6. [ 서버 ] ESTABLISHED 

  

##### TCP의 연결해제과정: 4-웨이 핸드쉐이크와 TIME_WAIT

1. 먼저 클라이언트가 연결을 닫으려고 할 때 FIN으로 설정된 세그먼트를 보냅니다. 
   그리고 클라이언트는 FIN_WAIT_1 상태로 들어가고 서버의 응답을 기다림.
2. 서버는 클라이언트로 ACK라는 승인 세그먼트를 보내고 CLOSE_WAIT 상태에 들어갑니다. 
   클라이언트가 세그먼트를 받으면 FIN_WAIT_2 상태에 들어감.
3. 서버는 LAST_ACK상태가 되며 일정 시간 이후에 클라이언트에 FIN이라는 세그먼트를 보냄.
4. 클라이언트는 TIME_WAIT 상태가 되고 다시 서버로 ACK를 보내서 서버는 CLOSED 상태가 되며 이후 클라이언트는 어느 정도의 시간(TIME_WAIT으로 설정된 시간)을 대기한 후 연결이 닫힘.

- TIME_WAIT이 바로 CLOSED 되지 않는 이유
  - 지연 패킷이 발생했을 때 데이터 무결성을 해결하기 위함. 
    두 배의 최대 세그먼트 수명(MSL) 시간을 기다립니다. 기본적으로 MSL은 2분입니다. 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태를 말하며 지연 패킷 등의 문제점을 해결하는 데 쓰입니다. 또한 연결을 올바르게 닫힌상태로ㅇ 만들기 위해 존재합니다. 예를 들어 CLOSED가 아닌 LAST_ACK로 되어 있으면 그 다음 연결 때 오류가 나타납니다.
