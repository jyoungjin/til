## 웹 브라우저의 캐시

---

##### #1. 로컬 스토리지의 개념

- 로컬스토리지는 웹 스토리지 객체로 브라우저 내에 { key : value } 형태로 **오리진에 종속되어 저장되는 데이터**를 말합니다. 
  (오리진이 같은 브라우저 내에서 공유 됩니다.)
  - 하나의 키에 오로지 하나의 값만 저장됩니다.
  - 데이터는 사용자가 브라우저에서 수동으로 삭제하지 않는 한 평생 동안 로컬 저장소에 저장되며 만료날짜가 없습니다. 
    사용자가 창이나 탭을 닫아도, 컴퓨터를 종료해도 만료되지 않습니다.
  - 최대 저장용량은 5MB입니다.
  - 보통 사용자의 행위를 기억할 때, 로그인을 유지하기 위한 값 등으로 사용되며 **로컬 스토리지 데이터는 자동으로 서버로 전송되지 않습니다.** (쿠키는 자동 전송됨)
  - 사용법
    - 설정 : localStorage.setItem(key, value);
    - key에 해당하는 value가져오기 : localStorage.getItem(key);
    - 제거 : localStorage.removeItem(key);
    - 전체제거 : localStorage.clear()



##### #2. 로컬 스토리지와 오리진

- 오리진: protocol + host name + port (예: https://www.naver.com:443)



##### #3. 로컬 스토리지를 활용한 UX 개선

1. **로그인 유지**
   - 로그인을 통해 받은 토큰을 localStorage에 저장해두었다가 일반적으로 header-authorization 필드에 토큰 값을 첨부하여 API를 요청해서 로그인을 유지한다.
2. **캐싱**
   - 예: 자동완성 (이전에 입력한 값)



##### #4. 세션 스토리지 - [ 로컬 스토리지와의 차이점: 브라우저에서 탭을 닫으면 데이터는 만료 ]

- 세션 스토리지(session Storage)는 로컬 스토리지와 매우 유사합니다.
  세션 스토리지는 웹 스토리지 객체로 브라우저 내에 { key : value } 형태로 오리진에 종속되어 저장되는 데이터를 말합니다. (오리진이 같은 브라우저 내에서 공유 됩니다.)

  - 하나의 키에 오로지 하나의 값만 저장됩니다.

  - 최대 저장용량은 5MB입니다.

  - **사용자가 브라우저에서 탭을 닫으면 데이터는 만료 됩니다.**

- 세션스토리지 사용법

  - 설정 : sessionStorage.setItem(key, value);
  - 탐색 : sessionStorage.getItem(key);
  - 제거 : sessionStorage.removeItem(key);
  - 전체제거 : sessionStorage.clear();



##### #5. HTTP 헤더

- 헤더는 콜론 ':'으로 서로 구분되는 key-value 형태로 설정됩니다.
  HTTP 요청을 할 때 3가지의 헤더인 일반헤더, 요청헤더, 응답헤더가 자동으로 생깁니다.
  여기서 서버에서 설정하는 헤더를 응답헤더, 클라이언트에서 설정한 헤더를 요청헤더라고 합니다.

1. 일반 헤더
   - 요청한 URL, 요청메서드, 해당 자원을 요청할 때 해당 자원의 출처를 나타내는 URL을 노출시킬지 말지를 정하는 보안 정도가 설정되어있는 Referrer Policy 등이 들어갑니다.
2. 요청 헤더
   - 요청 헤더는 클라이언트가 서버에 요청할 때 클라이언트가 설정하는 또는 자동으로 설정되는 헤더를 말합니다. 
     요청 헤더에는 메서드, 클라이언트의 OS, 브라우저 정보 등이 담깁니다.
3. 응답 헤더
   - 응답헤더는 서버가 클라이언트에게 응답을 보낼 때 설정하는 또는 자동으로 설정되는 헤더를 말합니다.
     응답 헤더는 서버의 소프트웨어 정보 등이 담깁니다. 예를 들어 nginx를 프록시서버로 두었다면 해당 정보가 표기됩니다. 
     하지만 대부분의 서버는 일반적으로 해커가 서버에서 어떤 소프트웨어가 사용되고 있는지 알기 어렵게 하기 위해 서버 정보를 숨깁니다.
     response Headers의 server : NWS 라고 되어있는데 이는 Naver Web Server를 의미합니다. 
     gzip 압축 알고리즘을 쓰는 것만 나와있을 뿐 자세하게 표기가 안되는 것을 볼 수 있죠?
4. HTTP 헤더자체가 굉장히 유연하게 설계가 되어있어서 이렇게 커스텀하게 만들 수 있지만 보통은 지정되어있는 key값에 value를 담아서 헤더를 설정합니다.
   예를 들어 쿠키를 설정할 때 요청헤더에는 Cookie라는 key에, 응답헤더에는 Set-cookie라는 key에 쿠키를 담아 설정합니다.



##### #6. 쿠키(Cookie)

- 쿠키는 브라우저에 저장된 데이터 조각입니다. 
  클라이언트에서 먼저 설정할 수도 있고 서버에서 먼저 설정할 수 있으나 보통은 서버에서 먼저 설정해서 쿠키를 만드는게 일반적입니다.
  서버에서 응답헤더로 Set-Cookie로 설정해서 쿠키를 보내면 그 때 부터 클라이언트에서 요청헤더 Cookie에 설정되어 자동으로 서버에 전달되게 되고 브라우저에도 저장 되게 됩니다.

  - HTTP 헤더를 통해 클라이언트 또는 서버가 HTTP 요청 또는 응답할 때 추가 정보를 전달할 수 있습니다.

- 쿠키는 클라이언트와 서버 둘 다 조작이 가능하지만 보통 서버에서 만료기한 등을 설정 및 컨트롤을 합니다. 저장용량은 최대 4kb까지 가능합니다.

- 보통 로그인, 장바구니, 사용자 커스터마이징, 사용자 행동분석(주로 개인화된 광고에 활용되는 것들)에 사용됩니다.

- 클라이언트에서도 설정 가능한 쿠키

  - 클라이언트에서 자바스크립트 - document.cookie를 통해 쿠키를 설정할 수 있고 보낼 때도 이런식으로 header - Cookie에 값을 정해서 보낼 수도 있습니다. 하지만 이를 권장하지는 않습니다.
  - 이렇게 되면 쿠키에 대한 제어권을 클라이언트에게 두게 되는데 쿠키에는 보통 민감한 정보들이 담길 수도 있기 때문에 이 제어권에 관한 것을 클라이언트가 아닌 서버가 두게 만들어야 합니다.

- 세션 쿠키

  - 세션 쿠키는 Expires 또는 Max-Age 속성을 지정하지 않은 것을 말합니다. 브라우저가 종료되면 쿠키도 사라집니다.

- 영구 쿠키

  - 영구 쿠키는 Expires 또는 Max-Age 속성을 지정해서 특정날짜 또는 일정기간이 지나면 삭제되게 만든 쿠키, 브라우저를 닫을 때 만료되지 않습니다.

- 문법

  - ```yaml
    Set-Cookie: <cookie-name>=<cookie-value>
    Set-Cookie: <cookie-name>=<cookie-value>; Expires=<date>
    Set-Cookie: <cookie-name>=<cookie-value>; Max-Age=<non-zero-digit>
    Set-Cookie: <cookie-name>=<cookie-value>; Domain=<domain-value>
    Set-Cookie: <cookie-name>=<cookie-value>; Path=<path-value>
    # Secure: HTTPS로만 쿠키를 주고받을 수 있게 하는 옵션 - 크롬 52 이상 이 옵션을 무시
    Set-Cookie: <cookie-name>=<cookie-value>; Secure 
    # HttpOnly: 공격자가 자바스크립트로 빼낼 수 없게 만듭니다. (document.cookie로 접근 불가)
    Set-Cookie: <cookie-name>=<cookie-value>; HttpOnly
    # SameSite: 요청이 동일한 도메인에서 시작된 경우에만 쿠키가 애플리케이션으로 전송되도록 허용
    Set-Cookie: <cookie-name>=<cookie-value>; SameSite=Strict
    ```

- **쿠키의 시큐어코딩**

  - 쿠키 - 세션으로 로그인을 처리한다면 다음과 같은 시큐어 코딩을 해야 합니다.
    1. cookie에 세션ID를 담을 때 이 세션ID기반으로 클라이언트의 개인정보를 유추할 수 없게 해야 합니다.
    2. 자바스크립트로는 파악할 수 없게 http only 옵션을 걸어야 합니다.
    3. 일정시간의 세션 타임아웃 걸어야 합니다.



##### \#6. 로컬스토리지, 세션스토리지, 쿠키의 공통점과 차이점

- 공통점

  1. 브라우저에 캐싱을 함으로써 서버에 대한 요청을 줄여 서버 부하를 방지할 수 있습니다.
  2. 캐싱으로 인해 다운로드 하는 컨텐츠가 줄어들어 웹사이트의 컨텐츠를 더 빨리 다운로드가 가능합니다.
  3. 사이트 기본 설정 커스터마이징(색상, 글꼴 크기 등)을 저장하거나 로그인 상태를 유지할 때 사용될 수 있습니다.

- 차이점

  - |                                        |       쿠키        | 로컬 스토리지 | 세션 스토리지  |
    | -------------------------------------- | :---------------: | :-----------: | :------------: |
    | 최대저장용량                           |        4KB        |      5MB      |      5MB       |
    | 브라우저 허용                          |     HTML4 + 5     |     HTML5     |     HTML5      |
    | 접근 범위                              |        창         |      창       |       탭       |
    | 만료 기한                              |   수동으로 설정   |    영구적     | 탭 닫으면 소멸 |
    | 설정할 수 있는 주체                    | 클라이언트 + 서버 |  클라이언트   |   클라이언트   |
    | 요청과 함께 서버에 <br />자동전송 유무 |         O         |       X       |       X        |
